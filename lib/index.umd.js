!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("did-jwt")):"function"==typeof define&&define.amd?define(["exports","did-jwt"],t):t((e||self).didJwtVc={},e.didJwt)}(this,function(e,t){const r="ES256K",i=/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/,n="https://www.w3.org/2018/credentials/v1",o="VerifiableCredential",a="VerifiablePresentation",c="JwtProof2020",s=["evidence","termsOfUse","refreshService","credentialSchema","credentialStatus"];function l(e){return Array.isArray(e)?e:[e]}function f(e){return Array.isArray(e)?e.map(e=>f(e)):e instanceof Date?new Date(e.getTime()):e&&"object"==typeof e?Object.getOwnPropertyNames(e).reduce((t,r)=>(Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r)),t[r]=f(e[r]),t),Object.create(Object.getPrototypeOf(e))):e}function d(e){return null!=e}function p(e,t=!0){let r=f(e);var i;"object"==typeof(i=e)&&i.sub&&i.iss&&i.claim&&i.iat&&(r=function(e){const{iat:t,nbf:r,claim:i,vc:a,...c}=e,s={...c,nbf:r||t,vc:{"@context":[n],type:[o],credentialSubject:i}};return a&&(e.issVc=a),s}(e)),r.credentialSubject={...e.credentialSubject,...e.vc?.credentialSubject},e.sub&&!e.credentialSubject?.id&&r.credentialSubject&&(r.credentialSubject.id=e.sub,t&&delete r.sub),t&&r.vc?.credentialSubject,void 0!==e.issuer&&"object"!=typeof e.issuer||(r.issuer=function(e){if("object"!=typeof e)return e;const t={...e};return Object.keys(t).forEach(e=>void 0===t[e]&&delete t[e]),t}({id:e.iss,...e.issuer}),t&&!e.issuer?.id&&delete r.iss),!e.id&&e.jti&&(r.id=r.id||r.jti,t&&delete r.jti);const a=[...l(r.type),...l(r.vc?.type)].filter(d);r.type=[...new Set(a)],t&&r.vc?.type;for(const i of s)e.vc&&e.vc[i]&&(r[i]||(r[i]=e.vc[i]),t&&delete r.vc[i]);const c=[...l(e.context),...l(e["@context"]),...l(e.vc?.["@context"])].filter(d);return r["@context"]=[...new Set(c)],t&&(delete r.context,r.vc?.["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(r.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete r.nbf:delete r.iat)),!e.expirationDate&&e.exp&&(r.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete r.exp),t&&r.vc&&0===Object.keys(r.vc).length&&delete r.vc,r}function u(e,r=!0){let i;try{i=t.decodeJWT(e)}catch(e){throw new TypeError("unknown credential format")}return{...p(i.payload,r),proof:{type:c,jwt:e}}}function v(e,t=!0){if("string"==typeof e){if(i.test(e))return u(e,t);{let r;try{r=JSON.parse(e)}catch(e){throw new TypeError("unknown credential format")}return v(r,t)}}return e.proof?.jwt?f({...u(e.proof.jwt,t),proof:e.proof}):{proof:{},...p(e,t)}}function y(e,t=!0){if(Array.isArray(e.credentialSubject))throw Error("credentialSubject of type array not supported");const r=f({vc:{...e.vc},...e});r.vc=r.vc;const i={...e.credentialSubject,...e.vc?.credentialSubject};e.sub||(r.sub=e.credentialSubject?.id,t&&delete i.id);const n=[...l(e.context),...l(e["@context"]),...l(e.vc?.["@context"])].filter(d);r.vc["@context"]=[...new Set(n)],t&&(delete r.context,delete r["@context"]);const o=[...l(e.type),...l(e.vc?.type)].filter(d);if(r.vc.type=[...new Set(o)],t&&delete r.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(r.jti=e.id,t&&delete r.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const i=Date.parse(e.issuanceDate);isNaN(i)||(r.nbf=Math.floor(i/1e3),t&&delete r.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const i=Date.parse(e.expirationDate);isNaN(i)||(r.exp=Math.floor(i/1e3),t&&delete r.expirationDate)}e.issuer&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&("object"==typeof e.issuer?(r.iss=e.issuer?.id,t&&(delete r.issuer.id,0===Object.keys(r.issuer).length&&delete r.issuer)):"string"==typeof e.issuer&&(r.iss=e.iss||""+e.issuer,t&&delete r.issuer)),r.vc.credentialSubject=i,t&&delete r.credentialSubject;for(const i of s)e[i]&&(r.vc[i]||(r.vc[i]=e[i]),t&&delete r[i]);return r}function b(e,t=!0){const r=f(e);r.verifiableCredential=[...l(e.verifiableCredential),...l(e.vp?.verifiableCredential)].filter(d),r.verifiableCredential=r.verifiableCredential.map(e=>v(e,t)),t&&r.vp?.verifiableCredential,e.iss&&!e.holder&&(r.holder=e.iss,t&&delete r.iss),e.aud&&(r.verifier=[...l(e.verifier),...l(e.aud)].filter(d),r.verifier=[...new Set(r.verifier)],t&&delete r.aud),e.jti&&-1===Object.getOwnPropertyNames(e).indexOf("id")&&(r.id=e.id||e.jti,t&&delete r.jti);const i=[...l(e.type),...l(e.vp?.type)].filter(d);r.type=[...new Set(i)],t&&r.vp?.type;const n=[...l(e.context),...l(e["@context"]),...l(e.vp?.["@context"])].filter(d);return r["@context"]=[...new Set(n)],t&&(delete r.context,r.vp?.["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(r.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete r.nbf:delete r.iat)),!e.expirationDate&&e.exp&&(r.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete r.exp),r.vp&&0===Object.keys(r.vp).length&&t&&delete r.vp,r}function w(e,r=!0){let i;try{i=t.decodeJWT(e)}catch(e){throw new TypeError("unknown presentation format")}return{...b(i.payload,r),proof:{type:c,jwt:e}}}function x(e,t=!0){if("string"==typeof e){if(i.test(e))return w(e,t);{let r;try{r=JSON.parse(e)}catch(e){throw new TypeError("unknown presentation format")}return x(r,t)}}return e.proof?.jwt?{...w(e.proof.jwt,t),proof:e.proof}:{proof:{},...b(e,t)}}function j(e,t=!0){const r=f({vp:{...e.vp},...e});r.vp=r.vp;const i=[...l(e.context),...l(e["@context"]),...l(e.vp?.["@context"])].filter(d);r.vp["@context"]=[...new Set(i)],t&&(delete r.context,delete r["@context"]);const n=[...l(e.type),...l(e.vp?.type)].filter(d);if(r.vp.type=[...new Set(n)],t&&delete r.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(r.jti=e.id,t&&delete r.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const i=Date.parse(e.issuanceDate);isNaN(i)||(r.nbf=Math.floor(i/1e3),t&&delete r.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const i=Date.parse(e.expirationDate);isNaN(i)||(r.exp=Math.floor(i/1e3),t&&delete r.expirationDate)}if((r.verifiableCredential||r.vp?.verifiableCredential)&&(r.vp.verifiableCredential=[...l(r.verifiableCredential),...l(r.vp?.verifiableCredential)].filter(d).map(e=>"object"==typeof e&&e.proof?.jwt?e.proof.jwt:e)),t&&delete r.verifiableCredential,e.holder&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&"string"==typeof e.holder&&(r.iss=e.holder,t&&delete r.holder),e.verifier){const i=[...l(e.verifier),...l(e.aud)].filter(d);r.aud=[...new Set(i)],t&&delete r.verifier}return r}function h(e){if("string"==typeof e&&!e.match(i))throw new TypeError(`"${e}" is not a valid JWT format`)}function g(e){if("number"==typeof e){if(!(Number.isInteger(e)&&e<1e11))throw new TypeError(`"${e}" is not a unix timestamp in seconds`)}else if("string"==typeof e)g(Math.floor(new Date(e).valueOf()/1e3));else if(!(t=e)||isNaN(t)||"[object Date]"!==Object.prototype.toString.call(t))throw new TypeError(`"${e}" is not a valid time`);var t}function m(e){const t=l(e);if(t.length<1||-1===t.indexOf(n))throw new TypeError(`@context is missing default context "${n}"`)}function O(e){const t=l(e);if(t.length<1||-1===t.indexOf(o))throw new TypeError(`type is missing default "${o}"`)}function S(e){const t=l(e);if(t.length<1||-1===t.indexOf(a))throw new TypeError(`type is missing default "${a}"`)}function P(e){if(0===Object.keys(e).length)throw new TypeError("credentialSubject must not be empty")}function D(e){m(e.vc["@context"]),O(e.vc.type),P(e.vc.credentialSubject),e.nbf&&g(e.nbf),e.exp&&g(e.exp)}function C(e){m(e["@context"]),O(e.type),P(e.credentialSubject),e.issuanceDate&&g(e.issuanceDate),e.expirationDate&&g(e.expirationDate)}function N(e){if(m(e.vp["@context"]),S(e.vp.type),e.vp.verifiableCredential&&e.vp.verifiableCredential.length>=1)for(const t of l(e.vp.verifiableCredential))"string"==typeof t?h(t):C(t);e.exp&&g(e.exp)}function T(e){if(m(e["@context"]),S(e.type),e.verifiableCredential&&e.verifiableCredential.length>=1)for(const t of e.verifiableCredential)"string"==typeof t?h(t):C(t);e.expirationDate&&g(e.expirationDate)}function J(e,t){if(t.challenge&&t.challenge!==e.nonce)throw new Error(`Presentation does not contain the mandatory challenge (JWT: nonce) for : ${t.challenge}`);if(t.domain){let r;if(e.aud&&(r=(Array.isArray(e.aud)?e.aud:[e.aud]).find(e=>t.domain===e)),void 0===r)throw new Error(`Presentation does not contain the mandatory domain (JWT: aud) for : ${t.domain}`)}}e.createVerifiableCredentialJwt=function(e,i,n={}){try{const o={iat:void 0,...y(e,n.removeOriginalFields)};return D(o),Promise.resolve(t.createJWT(o,{...n,issuer:i.did||o.iss||"",signer:i.signer},{...n.header,alg:i.alg||n.header?.alg||r}))}catch(e){return Promise.reject(e)}},e.createVerifiablePresentationJwt=function(e,i,n={}){try{const o={iat:void 0,...j(e,n?.removeOriginalFields)};if(n.challenge&&-1===Object.getOwnPropertyNames(o).indexOf("nonce")&&(o.nonce=n.challenge),n.domain){const e=[...l(n.domain),...l(o.aud)].filter(d);o.aud=[...new Set(e)]}return N(o),Promise.resolve(t.createJWT(o,{...n,issuer:i.did||o.iss||"",signer:i.signer},{...n.header,alg:i.alg||n.header?.alg||r}))}catch(e){return Promise.reject(e)}},e.normalizeCredential=v,e.normalizePresentation=x,e.transformCredentialInput=y,e.transformPresentationInput=j,e.validateCredentialPayload=C,e.validateJwtCredentialPayload=D,e.validateJwtPresentationPayload=N,e.validatePresentationPayload=T,e.verifyCredential=function(e,r,i={}){try{return Promise.resolve(t.verifyJWT(e,{resolver:r,...i})).then(function(e){return e.verifiableCredential=v(e.jwt,i?.removeOriginalFields),C(e.verifiableCredential),e})}catch(e){return Promise.reject(e)}},e.verifyPresentation=function(e,r,i={}){try{return Promise.resolve(t.verifyJWT(e,{resolver:r,...i})).then(function(e){return J(e.payload,i),e.verifiablePresentation=x(e.jwt,i?.removeOriginalFields),T(e.verifiablePresentation),e})}catch(e){return Promise.reject(e)}},e.verifyPresentationPayloadOptions=J});
//# sourceMappingURL=index.umd.js.map
