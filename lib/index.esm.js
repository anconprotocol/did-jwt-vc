import{decodeJWT as e,verifyJWT as t,createJWT as r}from"did-jwt";const i=/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/,n="https://www.w3.org/2018/credentials/v1",o=["evidence","termsOfUse","refreshService","credentialSchema","credentialStatus"];function a(e){return Array.isArray(e)?e:[e]}function c(e){return Array.isArray(e)?e.map(e=>c(e)):e instanceof Date?new Date(e.getTime()):e&&"object"==typeof e?Object.getOwnPropertyNames(e).reduce((t,r)=>(Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r)),t[r]=c(e[r]),t),Object.create(Object.getPrototypeOf(e))):e}function s(e){return null!=e}function l(e,t=!0){let r=c(e);var i;"object"==typeof(i=e)&&i.sub&&i.iss&&i.claim&&i.iat&&(r=function(e){const{iat:t,nbf:r,claim:i,vc:o,...a}=e,c={...a,nbf:r||t,vc:{"@context":[n],type:["VerifiableCredential"],credentialSubject:i}};return o&&(e.issVc=o),c}(e)),r.credentialSubject={...e.credentialSubject,...e.vc?.credentialSubject},e.sub&&!e.credentialSubject?.id&&r.credentialSubject&&(r.credentialSubject.id=e.sub,t&&delete r.sub),t&&r.vc?.credentialSubject,void 0!==e.issuer&&"object"!=typeof e.issuer||(r.issuer=function(e){if("object"!=typeof e)return e;const t={...e};return Object.keys(t).forEach(e=>void 0===t[e]&&delete t[e]),t}({id:e.iss,...e.issuer}),t&&!e.issuer?.id&&delete r.iss),!e.id&&e.jti&&(r.id=r.id||r.jti,t&&delete r.jti);const l=[...a(r.type),...a(r.vc?.type)].filter(s);r.type=[...new Set(l)],t&&r.vc?.type;for(const i of o)e.vc&&e.vc[i]&&(r[i]||(r[i]=e.vc[i]),t&&delete r.vc[i]);const f=[...a(e.context),...a(e["@context"]),...a(e.vc?.["@context"])].filter(s);return r["@context"]=[...new Set(f)],t&&(delete r.context,r.vc?.["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(r.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete r.nbf:delete r.iat)),!e.expirationDate&&e.exp&&(r.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete r.exp),t&&r.vc&&0===Object.keys(r.vc).length&&delete r.vc,r}function f(t,r=!0){let i;try{i=e(t)}catch(e){throw new TypeError("unknown credential format")}return{...l(i.payload,r),proof:{type:"JwtProof2020",jwt:t}}}function d(e,t=!0){if("string"==typeof e){if(i.test(e))return f(e,t);{let r;try{r=JSON.parse(e)}catch(e){throw new TypeError("unknown credential format")}return d(r,t)}}return e.proof?.jwt?c({...f(e.proof.jwt,t),proof:e.proof}):{proof:{},...l(e,t)}}function p(e,t=!0){if(Array.isArray(e.credentialSubject))throw Error("credentialSubject of type array not supported");const r=c({vc:{...e.vc},...e});r.vc=r.vc;const i={...e.credentialSubject,...e.vc?.credentialSubject};e.sub||(r.sub=e.credentialSubject?.id,t&&delete i.id);const n=[...a(e.context),...a(e["@context"]),...a(e.vc?.["@context"])].filter(s);r.vc["@context"]=[...new Set(n)],t&&(delete r.context,delete r["@context"]);const l=[...a(e.type),...a(e.vc?.type)].filter(s);if(r.vc.type=[...new Set(l)],t&&delete r.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(r.jti=e.id,t&&delete r.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const i=Date.parse(e.issuanceDate);isNaN(i)||(r.nbf=Math.floor(i/1e3),t&&delete r.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const i=Date.parse(e.expirationDate);isNaN(i)||(r.exp=Math.floor(i/1e3),t&&delete r.expirationDate)}e.issuer&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&("object"==typeof e.issuer?(r.iss=e.issuer?.id,t&&(delete r.issuer.id,0===Object.keys(r.issuer).length&&delete r.issuer)):"string"==typeof e.issuer&&(r.iss=e.iss||""+e.issuer,t&&delete r.issuer)),r.vc.credentialSubject=i,t&&delete r.credentialSubject;for(const i of o)e[i]&&(r.vc[i]||(r.vc[i]=e[i]),t&&delete r[i]);return r}function u(e,t=!0){const r=c(e);r.verifiableCredential=[...a(e.verifiableCredential),...a(e.vp?.verifiableCredential)].filter(s),r.verifiableCredential=r.verifiableCredential.map(e=>d(e,t)),t&&r.vp?.verifiableCredential,e.iss&&!e.holder&&(r.holder=e.iss,t&&delete r.iss),e.aud&&(r.verifier=[...a(e.verifier),...a(e.aud)].filter(s),r.verifier=[...new Set(r.verifier)],t&&delete r.aud),e.jti&&-1===Object.getOwnPropertyNames(e).indexOf("id")&&(r.id=e.id||e.jti,t&&delete r.jti);const i=[...a(e.type),...a(e.vp?.type)].filter(s);r.type=[...new Set(i)],t&&r.vp?.type;const n=[...a(e.context),...a(e["@context"]),...a(e.vp?.["@context"])].filter(s);return r["@context"]=[...new Set(n)],t&&(delete r.context,r.vp?.["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(r.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete r.nbf:delete r.iat)),!e.expirationDate&&e.exp&&(r.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete r.exp),r.vp&&0===Object.keys(r.vp).length&&t&&delete r.vp,r}function v(t,r=!0){let i;try{i=e(t)}catch(e){throw new TypeError("unknown presentation format")}return{...u(i.payload,r),proof:{type:"JwtProof2020",jwt:t}}}function b(e,t=!0){if("string"==typeof e){if(i.test(e))return v(e,t);{let r;try{r=JSON.parse(e)}catch(e){throw new TypeError("unknown presentation format")}return b(r,t)}}return e.proof?.jwt?{...v(e.proof.jwt,t),proof:e.proof}:{proof:{},...u(e,t)}}function y(e,t=!0){const r=c({vp:{...e.vp},...e});r.vp=r.vp;const i=[...a(e.context),...a(e["@context"]),...a(e.vp?.["@context"])].filter(s);r.vp["@context"]=[...new Set(i)],t&&(delete r.context,delete r["@context"]);const n=[...a(e.type),...a(e.vp?.type)].filter(s);if(r.vp.type=[...new Set(n)],t&&delete r.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(r.jti=e.id,t&&delete r.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const i=Date.parse(e.issuanceDate);isNaN(i)||(r.nbf=Math.floor(i/1e3),t&&delete r.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const i=Date.parse(e.expirationDate);isNaN(i)||(r.exp=Math.floor(i/1e3),t&&delete r.expirationDate)}if((r.verifiableCredential||r.vp?.verifiableCredential)&&(r.vp.verifiableCredential=[...a(r.verifiableCredential),...a(r.vp?.verifiableCredential)].filter(s).map(e=>"object"==typeof e&&e.proof?.jwt?e.proof.jwt:e)),t&&delete r.verifiableCredential,e.holder&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&"string"==typeof e.holder&&(r.iss=e.holder,t&&delete r.holder),e.verifier){const i=[...a(e.verifier),...a(e.aud)].filter(s);r.aud=[...new Set(i)],t&&delete r.verifier}return r}function w(e){if("string"==typeof e&&!e.match(i))throw new TypeError(`"${e}" is not a valid JWT format`)}function x(e){if("number"==typeof e){if(!(Number.isInteger(e)&&e<1e11))throw new TypeError(`"${e}" is not a unix timestamp in seconds`)}else if("string"==typeof e)x(Math.floor(new Date(e).valueOf()/1e3));else if(!(t=e)||isNaN(t)||"[object Date]"!==Object.prototype.toString.call(t))throw new TypeError(`"${e}" is not a valid time`);var t}function j(e){const t=a(e);if(t.length<1||-1===t.indexOf(n))throw new TypeError(`@context is missing default context "${n}"`)}function g(e){const t=a(e);if(t.length<1||-1===t.indexOf("VerifiableCredential"))throw new TypeError('type is missing default "VerifiableCredential"')}function h(e){const t=a(e);if(t.length<1||-1===t.indexOf("VerifiablePresentation"))throw new TypeError('type is missing default "VerifiablePresentation"')}function O(e){if(0===Object.keys(e).length)throw new TypeError("credentialSubject must not be empty")}const m=function(e,r,i={}){try{return Promise.resolve(t(e,{resolver:r,...i})).then(function(e){return A(e.payload,i),e.verifiablePresentation=b(e.jwt,i?.removeOriginalFields),T(e.verifiablePresentation),e})}catch(e){return Promise.reject(e)}},S=function(e,r,i={}){try{return Promise.resolve(t(e,{resolver:r,...i})).then(function(e){return e.verifiableCredential=d(e.jwt,i?.removeOriginalFields),C(e.verifiableCredential),e})}catch(e){return Promise.reject(e)}},D=function(e,t,i={}){try{const n={iat:void 0,...y(e,i?.removeOriginalFields)};if(i.challenge&&-1===Object.getOwnPropertyNames(n).indexOf("nonce")&&(n.nonce=i.challenge),i.domain){const e=[...a(i.domain),...a(n.aud)].filter(s);n.aud=[...new Set(e)]}return E(n),Promise.resolve(r(n,{...i,issuer:t.did||n.iss||"",signer:t.signer},{...i.header,alg:t.alg||i.header?.alg||"ES256K"}))}catch(e){return Promise.reject(e)}},P=function(e,t,i={}){try{const n={iat:void 0,...p(e,i.removeOriginalFields)};return N(n),Promise.resolve(r(n,{...i,issuer:t.did||n.iss||"",signer:t.signer},{...i.header,alg:t.alg||i.header?.alg||"ES256K"}))}catch(e){return Promise.reject(e)}};function N(e){j(e.vc["@context"]),g(e.vc.type),O(e.vc.credentialSubject),e.nbf&&x(e.nbf),e.exp&&x(e.exp)}function C(e){j(e["@context"]),g(e.type),O(e.credentialSubject),e.issuanceDate&&x(e.issuanceDate),e.expirationDate&&x(e.expirationDate)}function E(e){if(j(e.vp["@context"]),h(e.vp.type),e.vp.verifiableCredential&&e.vp.verifiableCredential.length>=1)for(const t of a(e.vp.verifiableCredential))"string"==typeof t?w(t):C(t);e.exp&&x(e.exp)}function T(e){if(j(e["@context"]),h(e.type),e.verifiableCredential&&e.verifiableCredential.length>=1)for(const t of e.verifiableCredential)"string"==typeof t?w(t):C(t);e.expirationDate&&x(e.expirationDate)}function A(e,t){if(t.challenge&&t.challenge!==e.nonce)throw new Error(`Presentation does not contain the mandatory challenge (JWT: nonce) for : ${t.challenge}`);if(t.domain){let r;if(e.aud&&(r=(Array.isArray(e.aud)?e.aud:[e.aud]).find(e=>t.domain===e)),void 0===r)throw new Error(`Presentation does not contain the mandatory domain (JWT: aud) for : ${t.domain}`)}}export{P as createVerifiableCredentialJwt,D as createVerifiablePresentationJwt,d as normalizeCredential,b as normalizePresentation,p as transformCredentialInput,y as transformPresentationInput,C as validateCredentialPayload,N as validateJwtCredentialPayload,E as validateJwtPresentationPayload,T as validatePresentationPayload,S as verifyCredential,m as verifyPresentation,A as verifyPresentationPayloadOptions};
//# sourceMappingURL=index.esm.js.map
